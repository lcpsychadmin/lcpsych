{% extends "base.html" %}
{% block title %}Manage Therapists | L+C Psych{% endblock %}

{% block head_extra %}
<style>
.table-card { width: 100%; border-collapse: collapse; }
.table-card td,
.table-card th { padding: 0.75rem 1rem; border-bottom: 1px solid rgba(15, 63, 70, 0.12); text-align: left; }
.table-card th { font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em; color: rgba(15, 63, 70, 0.68); }
.chip { display: inline-flex; align-items: center; gap: 0.4rem; border-radius: 999px; background: rgba(146, 220, 229, 0.25); color: #0f3f46; padding: 0.15rem 0.75rem; font-size: 0.75rem; font-weight: 600; }
.action-btn { border-radius: 0.75rem; border: 1px solid rgba(15, 63, 70, 0.14); padding: 0.45rem 0.9rem; font-size: 0.85rem; font-weight: 600; color: #0f3f46; background: #fff; transition: all 0.2s ease; }
.action-btn:hover,
.action-btn:focus-visible { background: #92DCE5; color: #005F6B; outline: none; box-shadow: 0 0 0 3px rgba(146, 220, 229, 0.45); }
.status-dot { width: 0.55rem; height: 0.55rem; border-radius: 999px; display: inline-block; }
.status-dot.is-on { background: #3C9C64; }
.status-dot.is-off { background: rgba(15, 63, 70, 0.35); }
.no-wrap { white-space: nowrap; }
.invite-card input[type="text"],
.invite-card input[type="email"],
.invite-card select { width: 100%; padding: 0.625rem 0.875rem; border-radius: 0.75rem; border: 1.5px solid rgba(146, 220, 229, 0.7); background: rgba(255, 255, 255, 0.96); transition: border-color 0.2s ease, box-shadow 0.2s ease; }
.invite-card input:focus,
.invite-card select:focus { border-color: #92DCE5; box-shadow: 0 0 0 4px rgba(146, 220, 229, 0.55); outline: none; }
.invite-card label { color: #0f3f46; font-weight: 600; display: block; margin-bottom: 0.25rem; }
.invite-card .errorlist { color: #b91c1c; margin: 0.25rem 0 0.5rem; }
.btn-primary { background: #3C9C64; color: #fff; border-radius: 0.75rem; padding: 0.65rem 1.6rem; font-weight: 600; border: 0; transition: background 0.2s ease, color 0.2s ease; }
.btn-primary:hover,
.btn-primary:focus-visible { background: #92DCE5; color: #005F6B; outline: none; box-shadow: 0 0 0 4px rgba(146, 220, 229, 0.45); }
.card-surface { background: #fff; border-radius: 1.25rem; box-shadow: 0 15px 40px rgba(0, 48, 57, 0.05); border: 1px solid rgba(146, 220, 229, 0.35); }
</style>
{% endblock %}

{% block content %}
<main id="content">
  <section class="relative overflow-hidden z-10 bg-brand-deep text-white pb-16 pt-16">
    <div class="max-w-[1100px] mx-auto px-4 text-center">
      <h1 class="text-4xl leading-tight font-semibold m-0">Manage therapists</h1>
      <p class="mt-3 mx-auto max-w-[760px] text-white/90 text-lg">Invite new teammates, adjust their public profile visibility, and control intake availability.</p>
    </div>
  </section>

  <section class="relative z-20 py-10 md:py-14 bg-brand-accent">
    <div class="max-w-[1200px] mx-auto px-4 space-y-10">
      {% if debug_activation_url %}
        <div class="card-surface p-5 md:p-6">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
              <p class="text-[#0f3f46] font-semibold text-lg m-0">Activation link{% if debug_activation_email %} for {{ debug_activation_email }}{% endif %}</p>
              <p class="text-slate-600 text-sm mt-1 mb-0">Copy and share this link manually while developing locally.</p>
            </div>
            <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
              <input id="activation-url" type="text" readonly class="rounded-xl border border-[#BEE3DB] px-4 py-2 text-sm flex-1" value="{{ debug_activation_url }}">
              <button type="button" id="copy-activation" class="action-btn no-wrap">Copy link</button>
            </div>
          </div>
        </div>
        <script>
          (function () {
            var btn = document.getElementById('copy-activation');
            if (!btn) return;
            btn.addEventListener('click', function () {
              var input = document.getElementById('activation-url');
              if (!input) return;
              var text = input.value;
              if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(function () {
                  btn.textContent = 'Copied!';
                  setTimeout(function () { btn.textContent = 'Copy link'; }, 1600);
                }).catch(function () {
                  input.select();
                  document.execCommand('copy');
                  btn.textContent = 'Copied!';
                  setTimeout(function () { btn.textContent = 'Copy link'; }, 1600);
                });
              } else {
                input.select();
                document.execCommand('copy');
                btn.textContent = 'Copied!';
                setTimeout(function () { btn.textContent = 'Copy link'; }, 1600);
              }
            });
          })();
        </script>
      {% endif %}

      <div class="card-surface p-6 md:p-8 invite-card">
        <h2 class="text-2xl font-semibold text-[#0f3f46] mb-6">Send an invitation</h2>
        <form method="post" class="space-y-4">
          {% csrf_token %}
          <input type="hidden" name="action" value="invite">
          {{ invite_form.as_p }}
          <div class="pt-2">
            <button type="submit" class="btn-primary">Send invite</button>
          </div>
        </form>
      </div>

      <div class="card-surface p-6 md:p-8">
        <h2 class="text-2xl font-semibold text-[#0f3f46] mb-4">Profile lookup lists</h2>
        <p class="text-slate-600 mb-6">Keep the shared options tidy so every therapist works from the same set of license types and client focus categories.</p>
        <div class="flex flex-col sm:flex-row gap-3">
          <a href="{% url 'accounts:license_types' %}" class="action-btn inline-flex items-center justify-center">Manage license types</a>
          <a href="{% url 'accounts:client_focuses' %}" class="action-btn inline-flex items-center justify-center">Manage client focuses</a>
        </div>
      </div>

      <div class="card-surface p-6 md:p-8">
        <h2 class="text-2xl font-semibold text-[#0f3f46] mb-4">Services &amp; homepage cards</h2>
        <p class="text-slate-600 mb-6">Refresh the homepage services grid and edit the rich content that powers each service detail page.</p>
        <div class="flex flex-col sm:flex-row gap-3">
          <a href="{% url 'accounts:services' %}" class="action-btn inline-flex items-center justify-center">Manage services</a>
        </div>
      </div>

      <div class="card-surface p-6 md:p-8">
        <h2 class="text-2xl font-semibold text-[#0f3f46] mb-6">Published therapists</h2>
        {% if therapists %}
          <div class="overflow-x-auto">
            <table class="table-card min-w-full">
              <thead>
                <tr>
                  <th class="no-wrap">Therapist</th>
                  <th>Email</th>
                  <th class="no-wrap">Published</th>
                  <th class="no-wrap">Accepting new clients</th>
                  <th>Last updated</th>
                  <th class="no-wrap">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for therapist in therapists %}
                  <tr>
                    <td>
                      <div class="font-semibold text-[#0f3f46]">{{ therapist.display_name|default:therapist.user.get_full_name|default:therapist.user.email }}</div>
                      {% if therapist.license_type %}<div class="text-sm text-slate-600">{{ therapist.license_type }}</div>{% endif %}
                    </td>
                    <td class="text-sm text-slate-700">{{ therapist.user.email }}</td>
                    <td>
                      <span class="chip">
                        <span class="status-dot {% if therapist.is_published %}is-on{% else %}is-off{% endif %}"></span>
                        {% if therapist.is_published %}Published{% else %}Hidden{% endif %}
                      </span>
                    </td>
                    <td>
                      <span class="chip">
                        <span class="status-dot {% if therapist.accepts_new_clients %}is-on{% else %}is-off{% endif %}"></span>
                        {% if therapist.accepts_new_clients %}Accepting{% else %}Not accepting{% endif %}
                      </span>
                    </td>
                    <td class="text-sm text-slate-600">{{ therapist.updated_at|date:"M j, Y" }}</td>
                    <td class="space-y-2">
                      <form method="post" class="inline">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="set_publish">
                        <input type="hidden" name="profile_id" value="{{ therapist.id }}">
                        <input type="hidden" name="value" value="{% if therapist.is_published %}0{% else %}1{% endif %}">
                        <button type="submit" class="action-btn">
                          {% if therapist.is_published %}Hide profile{% else %}Publish profile{% endif %}
                        </button>
                      </form>
                      <form method="post" class="inline">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="set_accepts">
                        <input type="hidden" name="profile_id" value="{{ therapist.id }}">
                        <input type="hidden" name="value" value="{% if therapist.accepts_new_clients %}0{% else %}1{% endif %}">
                        <button type="submit" class="action-btn">
                          {% if therapist.accepts_new_clients %}Pause intake{% else %}Accept clients{% endif %}
                        </button>
                      </form>
                      <a class="action-btn inline-flex items-center gap-1" href="{% url 'accounts:therapist_edit' therapist.id %}">Edit profile</a>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-slate-600 m-0">No therapist profiles found yet.</p>
        {% endif %}
      </div>

      <div class="card-surface p-6 md:p-8">
        <h2 class="text-2xl font-semibold text-[#0f3f46] mb-6">Therapist accounts without profiles</h2>
        {% if unassigned_users %}
          <ul class="space-y-4">
            {% for user in unassigned_users %}
              <li class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 border border-[#BEE3DB] rounded-xl px-4 py-3">
                <div>
                  <div class="font-semibold text-[#0f3f46]">{{ user.get_full_name|default:user.email }}</div>
                  <div class="text-sm text-slate-600">{{ user.email }}</div>
                </div>
                <form method="post" class="md:ml-auto">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="create_profile">
                  <input type="hidden" name="user_id" value="{{ user.id }}">
                  <button type="submit" class="action-btn">Create profile</button>
                </form>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-slate-600 m-0">All therapist accounts have profiles created.</p>
        {% endif %}
      </div>
    </div>
  </section>
</main>
{% endblock %}

{% block before_footer %}
  <div aria-hidden="true" class="w-full bg-brand-deep h-16"></div>
{% endblock %}
