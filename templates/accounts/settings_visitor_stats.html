{% extends "base.html" %}
{% block title %}Visitor Stats | L+C Psych{% endblock %}

{% block head_extra %}
{% include "accounts/partials/settings_nav_styles.html" %}
<style>
.card-surface { background: #fff; border-radius: 1.25rem; box-shadow: 0 15px 40px rgba(0, 48, 57, 0.05); border: 1px solid rgba(146, 220, 229, 0.35); }
.table-basic th, .table-basic td { padding: 0.6rem 0.4rem; border-bottom: 1px solid rgba(15, 63, 70, 0.08); }
.table-basic { table-layout: auto; width: 100%; }
.badge-muted { display: inline-block; padding: 0.2rem 0.6rem; border-radius: 999px; background: rgba(146, 220, 229, 0.22); color: #0f3f46; font-weight: 700; font-size: 0.8rem; }
.date-field-wrapper { position: relative; display: inline-flex; align-items: center; gap: 0.4rem; background: #f7f9f9; border: 1px solid rgba(15, 63, 70, 0.12); border-radius: 0.9rem; padding: 0.5rem 0.75rem; box-shadow: inset 0 1px 0 rgba(255,255,255,0.7); }
.date-field-icon { width: 18px; height: 18px; color: #0f3f46; opacity: 0.55; }
.date-field { appearance: none; -webkit-appearance: none; border: none; background: transparent; font-size: 0.98rem; color: #0f3f46; min-width: 150px; }
.date-field:focus { outline: none; }
.date-field-wrapper:focus-within { border-color: #92DCE5; box-shadow: 0 0 0 3px rgba(146, 220, 229, 0.35); }
.chart-legend { display: flex; gap: 12px; align-items: center; font-size: 0.95rem; color: #0f3f46; }
.legend-chip { display: inline-flex; align-items: center; gap: 8px; }
.legend-dot { width: 12px; height: 12px; border-radius: 50%; }
.legend-dot.sessions { background: #92DCE5; }
.legend-dot.views { background: #3C9C64; }
.line-chart-wrapper { position: relative; width: 100%; overflow: hidden; }
.line-chart { width: 100%; height: 240px; }
.chart-tooltip { position: absolute; pointer-events: none; background: #0f3f46; color: #fff; padding: 6px 8px; border-radius: 8px; font-size: 11px; box-shadow: 0 6px 18px rgba(0,0,0,0.16); transform: translate(-50%, -120%); display: none; white-space: nowrap; }
.chart-empty { color: #475569; font-size: 0.95rem; }
.table-scroll { max-height: 20rem; overflow-y: scroll !important; overflow-x: auto; scrollbar-width: thin; scrollbar-color: #94a3b8 #e2e8f0; scrollbar-gutter: stable both-edges; -webkit-overflow-scrolling: touch; }
.table-scroll table { width: 100%; border-collapse: collapse; }
.table-scroll::-webkit-scrollbar { width: 8px; height: 8px; }
.table-scroll::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 999px; }
.table-scroll::-webkit-scrollbar-track { background: #e2e8f0; border-radius: 999px; }

@media (max-width: 768px) {
  .table-basic { table-layout: fixed; font-size: 0.9rem; }
  .table-basic th, .table-basic td { padding: 0.45rem 0.35rem; white-space: normal; word-break: break-word; }
  .table-basic th { font-size: 0.8rem; }
}
</style>
{% endblock %}

{% block content %}
<main id="content">
  <section class="relative overflow-hidden z-10 bg-brand-deep text-white pb-12 pt-14">
    <div class="max-w-[1100px] mx-auto px-4 text-center">
      <h1 class="text-4xl leading-tight font-semibold m-0">Visitor stats</h1>
      <p class="mt-3 mx-auto max-w-[760px] text-white/90 text-lg">Anonymous sessions only, {{ range_label }} ({{ range_days }} days).</p>
      <p class="mt-2 mx-auto max-w-[760px] text-white/80 text-sm">Times shown in {{ active_timezone|default:"site timezone" }}.</p>
    </div>
  </section>

  <section class="relative z-20 py-10 md:py-14 bg-brand-accent">
<div class="elementor-1393">
      <div class="elementor-element elementor-element-a80adf4">
        <div class="e-con-inner">
          <div class="elementor-shape elementor-shape-top" aria-hidden="true" data-negative="false">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 283.5 27.8" preserveAspectRatio="none">
              <path class="elementor-shape-fill" d="M283.5,9.7c0,0-7.3,4.3-14,4.6c-6.8,0.3-12.6,0-20.9-1.5c-11.3-2-33.1-10.1-44.7-5.7 s-12.1,4.6-18,7.4c-6.6,3.2-20,9.6-36.6,9.3C131.6,23.5,99.5,7.2,86.3,8c-1.4,0.1-6.6,0.8-10.5,2c-3.8,1.2-9.4,3.8-17,4.7 c-3.2,0.4-8.3,1.1-14.2,0.9c-1.5-0.1-6.3-0.4-12-1.6c-5.7-1.2-11-3.1-15.8-3.7C6.5,9.2,0,10.8,0,10.8V0h283.5V9.7z M260.8,11.3 c-0.7-1-2-0.4-4.3-0.4c-2.3,0-6.1-1.2-5.8-1.1c0.3,0.1,3.1,1.5,6,1.9C259.7,12.2,261.4,12.3,260.8,11.3z M242.4,8.6 c0,0-2.4-0.2-5.6-0.9c-3.2-0.8-10.3-2.8-15.1-3.5c-8.2-1.1-15.8,0-15.1,0.1c0.8,0.1,9.6-0.6,17.6,1.1c3.3,0.7,9.3,2.2,12.4,2.7 C239.9,8.7,242.4,8.6,242.4,8.6z M185.2,8.5c1.7-0.7-13.3,4.7-18.5,6.1c-2.1,0.6-6.2,1.6-10,2c-3.9,0.4-8.9,0.4-8.8,0.5 c0,0.2,5.8,0.8,11.2,0c5.4-0.8,5.2-1.1,7.6-1.6C170.5,14.7,183.5,9.2,185.2,8.5z M199.1,6.9c0.2,0-0.8-0.4-4.8,1.1 c-4,1.5-6.7,3.5-6.9,3.7c-0.2,0.1,3.5-1.8,6.6-3C197,7.5,199,6.9,199.1,6.9z M283,6c-0.1,0.1-1.9,1.1-4.8,2.5s-6.9,2.8-6.7,2.7 c0.2,0,3.5-0.6,7.4-2.5C282.8,6.8,283.1,5.9,283,6z M31.3,11.6c0.1-0.2-1.9-0.2-4.5-1.2s-5.4-1.6-7.8-2C15,7.6,7.3,8.5,7.7,8.6 C8,8.7,15.9,8.3,20.2,9.3c2.2,0.5,2.4,0.5,5.7,1.6S31.2,11.9,31.3,11.6z M73,9.2c0.4-0.1,3.5-1.6,8.4-2.6c4.9-1.1,8.9-0.5,8.9-0.8 c0-0.3-1-0.9-6.2-0.3S72.6,9.3,73,9.2z M71.6,6.7C71.8,6.8,75,5.4,77.3,5c2.3-0.3,1.9-0.5,1.9-0.6c0-0.1-1.1-0.2-2.7,0.2 C74.8,5.1,71.4,6.6,71.6,6.7z M93.6,4.4c0.1,0.2,3.5,0.8,5.6,1.8c2.1,1,1.8,0.6,1.9,0.5c0.1-0.1-0.8-0.8-2.4-1.3 C97.1,4.8,93.5,4.2,93.6,4.4z M65.4,11.1c-0.1,0.3,0.3,0.5,1.9-0.2s2.6-1.3,2.2-1.2s-0.9,0.4-2.5,0.8C65.3,10.9,65.5,10.8,65.4,11.1 z M34.5,12.4c-0.2,0,2.1,0.8,3.3,0.9c1.2,0.1,2,0.1,2-0.2c0-0.3-0.1-0.5-1.6-0.4C36.6,12.8,34.7,12.4,34.5,12.4z M152.2,21.1 c-0.1,0.1-2.4-0.3-7.5-0.3c-5,0-13.6-2.4-17.2-3.5c-3.6-1.1,10,3.9,16.5,4.1C150.5,21.6,152.3,21,152.2,21.1z"/>
              <path class="elementor-shape-fill" d="M269.6,18c-0.1-0.1-4.6,0.3-7.2,0c-7.3-0.7-17-3.2-16.6-2.9c0.4,0.3,13.7,3.1,17,3.3 C267.7,18.8,269.7,18,269.6,18z"/>
              <path class="elementor-shape-fill" d="M227.4,9.8c-0.2-0.1-4.5-1-9.5-1.2c-5-0.2-12.7,0.6-12.3,0.5c0.3-0.1,5.9-1.8,13.3-1.2 S227.6,9.9,227.4,9.8z"/>
              <path class="elementor-shape-fill" d="M204.5,13.4c-0.1-0.1,2-1,3.2-1.1c1.2-0.1,2,0,2,0.3c0,0.3-0.1,0.5-1.6,0.4 C206.4,12.9,204.6,13.5,204.5,13.4z"/>
              <path class="elementor-shape-fill" d="M201,10.6c0-0.1-4.4,1.2-6.3,2.2c-1.9,0.9-6.2,3.1-6.1,3.1c0.1,0.1,4.2-1.6,6.3-2.6 S201,10.7,201,10.6z"/>
              <path class="elementor-shape-fill" d="M154.5,26.7c-0.1-0.1-4.6,0.3-7.2,0c-7.3-0.7-17-3.2-16.6-2.9c0.4,0.3,13.7,3.1,17,3.3 C152.6,27.5,154.6,26.8,154.5,26.7z"/>
              <path class="elementor-shape-fill" d="M41.9,19.3c0,0,1.2-0.3,2.9-0.1c1.7,0.2,5.8,0.9,8.2,0.7c4.2-0.4,7.4-2.7,7-2.6 c-0.4,0-4.3,2.2-8.6,1.9c-1.8-0.1-5.1-0.5-6.7-0.4S41.9,19.3,41.9,19.3z"/>
              <path class="elementor-shape-fill" d="M75.5,12.6c0.2,0.1,2-0.8,4.3-1.1c2.3-0.2,2.1-0.3,2.1-0.5c0-0.1-1.8-0.4-3.4,0 C76.9,11.5,75.3,12.5,75.5,12.6z"/>
              <path class="elementor-shape-fill" d="M15.6,13.2c0-0.1,4.3,0,6.7,0.5c2.4,0.5,5,1.9,5,2c0,0.1-2.7-0.8-5.1-1.4 C19.9,13.7,15.7,13.3,15.6,13.2z"/>
            </svg>
          </div>
          <div class="elementor-shape elementor-shape-bottom" aria-hidden="true" data-negative="false">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 283.5 27.8" preserveAspectRatio="none">
              <path class="elementor-shape-fill" d="M283.5,9.7c0,0-7.3,4.3-14,4.6c-6.8,0.3-12.6,0-20.9-1.5c-11.3-2-33.1-10.1-44.7-5.7 s-12.1,4.6-18,7.4c-6.6,3.2-20,9.6-36.6,9.3C131.6,23.5,99.5,7.2,86.3,8c-1.4,0.1-6.6,0.8-10.5,2c-3.8,1.2-9.4,3.8-17,4.7 c-3.2,0.4-8.3,1.1-14.2,0.9c-1.5-0.1-6.3-0.4-12-1.6c-5.7-1.2-11-3.1-15.8-3.7C6.5,9.2,0,10.8,0,10.8V0h283.5V9.7z M260.8,11.3 c-0.7-1-2-0.4-4.3-0.4c-2.3,0-6.1-1.2-5.8-1.1c0.3,0.1,3.1,1.5,6,1.9C259.7,12.2,261.4,12.3,260.8,11.3z M242.4,8.6 c0,0-2.4-0.2-5.6-0.9c-3.2-0.8-10.3-2.8-15.1-3.5c-8.2-1.1-15.8,0-15.1,0.1c0.8,0.1,9.6-0.6,17.6,1.1c3.3,0.7,9.3,2.2,12.4,2.7 C239.9,8.7,242.4,8.6,242.4,8.6z M185.2,8.5c1.7-0.7-13.3,4.7-18.5,6.1c-2.1,0.6-6.2,1.6-10,2c-3.9,0.4-8.9,0.4-8.8,0.5 c0,0.2,5.8,0.8,11.2,0c5.4-0.8,5.2-1.1,7.6-1.6C170.5,14.7,183.5,9.2,185.2,8.5z M199.1,6.9c0.2,0-0.8-0.4-4.8,1.1 c-4,1.5-6.7,3.5-6.9,3.7c-0.2,0.1,3.5-1.8,6.6-3C197,7.5,199,6.9,199.1,6.9z M283,6c-0.1,0.1-1.9,1.1-4.8,2.5s-6.9,2.8-6.7,2.7 c0.2,0,3.5-0.6,7.4-2.5C282.8,6.8,283.1,5.9,283,6z M31.3,11.6c0.1-0.2-1.9-0.2-4.5-1.2s-5.4-1.6-7.8-2C15,7.6,7.3,8.5,7.7,8.6 C8,8.7,15.9,8.3,20.2,9.3c2.2,0.5,2.4,0.5,5.7,1.6S31.2,11.9,31.3,11.6z M73,9.2c0.4-0.1,3.5-1.6,8.4-2.6c4.9-1.1,8.9-0.5,8.9-0.8 c0-0.3-1-0.9-6.2-0.3S72.6,9.3,73,9.2z M71.6,6.7C71.8,6.8,75,5.4,77.3,5c2.3-0.3,1.9-0.5,1.9-0.6c0-0.1-1.1-0.2-2.7,0.2 C74.8,5.1,71.4,6.6,71.6,6.7z M93.6,4.4c0.1,0.2,3.5,0.8,5.6,1.8c2.1,1,1.8,0.6,1.9,0.5c0.1-0.1-0.8-0.8-2.4-1.3 C97.1,4.8,93.5,4.2,93.6,4.4z M65.4,11.1c-0.1,0.3,0.3,0.5,1.9-0.2s2.6-1.3,2.2-1.2s-0.9,0.4-2.5,0.8C65.3,10.9,65.5,10.8,65.4,11.1 z M34.5,12.4c-0.2,0,2.1,0.8,3.3,0.9c1.2,0.1,2,0.1,2-0.2c0-0.3-0.1-0.5-1.6-0.4C36.6,12.8,34.7,12.4,34.5,12.4z M152.2,21.1 c-0.1,0.1-2.4-0.3-7.5-0.3c-5,0-13.6-2.4-17.2-3.5c-3.6-1.1,10,3.9,16.5,4.1C150.5,21.6,152.3,21,152.2,21.1z"/>
              <path class="elementor-shape-fill" d="M269.6,18c-0.1-0.1-4.6,0.3-7.2,0c-7.3-0.7-17-3.2-16.6-2.9c0.4,0.3,13.7,3.1,17,3.3 C267.7,18.8,269.7,18,269.6,18z"/>
              <path class="elementor-shape-fill" d="M227.4,9.8c-0.2-0.1-4.5-1-9.5-1.2c-5-0.2-12.7,0.6-12.3,0.5c0.3-0.1,5.9-1.8,13.3-1.2 S227.6,9.9,227.4,9.8z"/>
              <path class="elementor-shape-fill" d="M204.5,13.4c-0.1-0.1,2-1,3.2-1.1c1.2-0.1,2,0,2,0.3c0,0.3-0.1,0.5-1.6,0.4 C206.4,12.9,204.6,13.5,204.5,13.4z"/>
              <path class="elementor-shape-fill" d="M201,10.6c0-0.1-4.4,1.2-6.3,2.2c-1.9,0.9-6.2,3.1-6.1,3.1c0.1,0.1,4.2-1.6,6.3-2.6 S201,10.7,201,10.6z"/>
              <path class="elementor-shape-fill" d="M154.5,26.7c-0.1-0.1-4.6,0.3-7.2,0c-7.3-0.7-17-3.2-16.6-2.9c0.4,0.3,13.7,3.1,17,3.3 C152.6,27.5,154.6,26.8,154.5,26.7z"/>
              <path class="elementor-shape-fill" d="M41.9,19.3c0,0,1.2-0.3,2.9-0.1c1.7,0.2,5.8,0.9,8.2,0.7c4.2-0.4,7.4-2.7,7-2.6 c-0.4,0-4.3,2.2-8.6,1.9c-1.8-0.1-5.1-0.5-6.7-0.4S41.9,19.3,41.9,19.3z"/>
              <path class="elementor-shape-fill" d="M75.5,12.6c0.2,0.1,2-0.8,4.3-1.1c2.3-0.2,2.1-0.3,2.1-0.5c0-0.1-1.8-0.4-3.4,0 C76.9,11.5,75.3,12.5,75.5,12.6z"/>
              <path class="elementor-shape-fill" d="M15.6,13.2c0-0.1,4.3,0,6.7,0.5c2.4,0.5,5,1.9,5,2c0,0.1-2.7-0.8-5.1-1.4 C19.9,13.7,15.7,13.3,15.6,13.2z"/>
            </svg>
          </div>
        </div>
      </div>
    </div>
    <div class="max-w-[1200px] mx-auto px-4">
      <div class="settings-layout">
        {% include "accounts/partials/settings_nav.html" with active_page="visitor_stats" %}

        <div class="space-y-6">
          <div class="card-surface p-6">
            <form class="flex flex-wrap gap-4 items-end" method="get">
              <div>
                <label class="block text-sm font-semibold text-[#0f3f46] mb-1" for="start">Start date</label>
                <div class="date-field-wrapper">
                  <svg class="date-field-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M7 2a1 1 0 0 0-1 1v1H5a3 3 0 0 0-3 3v11a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3h-1V3a1 1 0 1 0-2 0v1H9V3A1 1 0 0 0 7 2Zm12 7H5v9a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V9Z"/></svg>
                  <input id="start" name="start" type="date" value="{{ start_date|date:'Y-m-d' }}" class="date-field">
                </div>
              </div>
              <div>
                <label class="block text-sm font-semibold text-[#0f3f46] mb-1" for="end">End date</label>
                <div class="date-field-wrapper">
                  <svg class="date-field-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M7 2a1 1 0 0 0-1 1v1H5a3 3 0 0 0-3 3v11a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3h-1V3a1 1 0 1 0-2 0v1H9V3A1 1 0 0 0 7 2Zm12 7H5v9a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V9Z"/></svg>
                  <input id="end" name="end" type="date" value="{{ end_date|date:'Y-m-d' }}" class="date-field">
                </div>
              </div>
              <div class="flex-1 min-w-[200px] text-sm text-slate-600">
                <span>Select up to the past 365 days. Default is last 30 days.</span>
              </div>
              <button type="submit" class="inline-flex items-center justify-center px-4 py-2 rounded-lg bg-[#3C9C64] text-white font-semibold hover:bg-[#92DCE5] hover:text-[#005F6B] transition-colors">Update range</button>
            </form>
          </div>

          <div class="card-surface p-6">
            <div class="flex items-center justify-between flex-wrap gap-3 mb-3">
              <h2 class="text-xl font-semibold text-[#0f3f46] m-0">Sessions vs page views</h2>
              <div class="chart-legend">
                <span class="legend-chip"><span class="legend-dot sessions"></span>Sessions</span>
                <span class="legend-chip"><span class="legend-dot views"></span>Page views</span>
              </div>
            </div>
            <div class="line-chart-wrapper">
              {% if chart_by_day %}
              {{ chart_by_day|json_script:"chart-data" }}
              <svg id="line-chart" class="line-chart" role="img" aria-label="Sessions and page views by day"></svg>
              <script>
                (() => {
                  const script = document.getElementById('chart-data');
                  if (!script) return;
                  const data = JSON.parse(script.textContent || '[]');
                  const svg = document.getElementById('line-chart');
                  if (!svg || !data.length) return;
                  const wrapper = svg.parentElement;
                  if (wrapper) {
                    wrapper.style.position = 'relative';
                  }

                  const tooltip = document.createElement('div');
                  tooltip.className = 'chart-tooltip';
                  if (wrapper) {
                    wrapper.appendChild(tooltip);
                  }

                  const showTooltip = (evt, text) => {
                    if (!tooltip || !wrapper) return;
                    tooltip.textContent = text;
                    tooltip.style.display = 'block';
                    const wrapRect = wrapper.getBoundingClientRect();
                    const ttRect = tooltip.getBoundingClientRect();
                    const offsetX = evt.clientX - wrapRect.left;
                    const offsetY = evt.clientY - wrapRect.top;
                    const pad = 8;
                    const halfW = ttRect.width / 2;
                    const clampedX = Math.min(Math.max(offsetX, pad + halfW), wrapRect.width - pad - halfW);
                    const clampedY = Math.min(Math.max(offsetY, pad + ttRect.height), wrapRect.height - pad);
                    tooltip.style.left = `${clampedX}px`;
                    tooltip.style.top = `${clampedY}px`;
                  };

                  const hideTooltip = () => {
                    if (!tooltip) return;
                    tooltip.style.display = 'none';
                  };

                  const padLeft = 64;
                  const padRight = 18;
                  const padTop = 20;
                  const padBottom = 56;
                  const width = svg.clientWidth || svg.parentElement.clientWidth || 800;
                  const height = svg.clientHeight || 260;
                  const plotWidth = width - padLeft - padRight;
                  const plotHeight = height - padTop - padBottom;
                  svg.setAttribute('viewBox', `0 0 ${width} ${height}`);

                  const formatDate = (iso) => {
                    const dt = new Date(`${iso}T00:00:00`);
                    if (Number.isNaN(dt.getTime())) return iso;
                    return dt.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
                  };

                  const maxValRaw = Math.max(...data.map(d => Math.max(d.sessions, d.page_views, 1)));
                  const maxVal = Math.max(maxValRaw, 4);
                  const stepX = data.length > 1 ? plotWidth / (data.length - 1) : 0;

                  const toX = (idx) => padLeft + idx * stepX;
                  const toY = (val) => padTop + (1 - val / maxVal) * plotHeight;

                  const buildPoints = (key) => data.map((d, idx) => `${toX(idx)},${toY(d[key])}`).join(' ');

                  const pvPoints = buildPoints('page_views');
                  const sessionPoints = buildPoints('sessions');

                  const makeLine = (points, color) => {
                    const el = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
                    el.setAttribute('points', points);
                    el.setAttribute('fill', 'none');
                    el.setAttribute('stroke', color);
                    el.setAttribute('stroke-width', '3');
                    el.setAttribute('stroke-linecap', 'round');
                    el.setAttribute('stroke-linejoin', 'round');
                    return el;
                  };

                  const axisGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                  axisGroup.setAttribute('stroke', '#d7e8ec');
                  axisGroup.setAttribute('stroke-width', '1');
                  axisGroup.setAttribute('fill', 'none');

                  const axisX = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                  axisX.setAttribute('x1', padLeft);
                  axisX.setAttribute('y1', height - padBottom);
                  axisX.setAttribute('x2', width - padRight);
                  axisX.setAttribute('y2', height - padBottom);

                  const axisY = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                  axisY.setAttribute('x1', padLeft);
                  axisY.setAttribute('y1', padTop);
                  axisY.setAttribute('x2', padLeft);
                  axisY.setAttribute('y2', height - padBottom);

                  axisGroup.appendChild(axisX);
                  axisGroup.appendChild(axisY);

                  const ticksY = 4;
                  const tickGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                  tickGroup.setAttribute('stroke', '#d7e8ec');
                  tickGroup.setAttribute('stroke-width', '1');
                  tickGroup.setAttribute('fill', 'none');

                  const labelGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                  labelGroup.setAttribute('fill', '#0f3f46');
                  labelGroup.setAttribute('font-size', '11');
                  labelGroup.setAttribute('font-family', 'inherit');

                  for (let i = 0; i <= ticksY; i += 1) {
                    const val = (maxVal / ticksY) * i;
                    const y = toY(val);
                    const grid = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    grid.setAttribute('x1', padLeft);
                    grid.setAttribute('x2', width - padRight);
                    grid.setAttribute('y1', y);
                    grid.setAttribute('y2', y);
                    grid.setAttribute('stroke', i === ticksY ? '#b7d6dd' : '#e3eff2');
                    grid.setAttribute('stroke-dasharray', i === ticksY ? '0' : '3 4');
                    tickGroup.appendChild(grid);

                    const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    label.setAttribute('x', padLeft - 10);
                    label.setAttribute('y', y + 4);
                    label.setAttribute('text-anchor', 'end');
                    label.textContent = Math.round(val).toString();
                    labelGroup.appendChild(label);
                  }

                  const pickXTickIndexes = () => {
                    if (data.length <= 5) return data.map((_, idx) => idx);
                    const last = data.length - 1;
                    return [0, Math.floor(last / 3), Math.floor((2 * last) / 3), last];
                  };

                  pickXTickIndexes().forEach((idx) => {
                    const x = toX(idx);
                    const tick = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    tick.setAttribute('x1', x);
                    tick.setAttribute('x2', x);
                    tick.setAttribute('y1', height - padBottom);
                    tick.setAttribute('y2', height - padBottom + 6);
                    tick.setAttribute('stroke', '#b7d6dd');
                    tickGroup.appendChild(tick);

                    const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    label.setAttribute('x', x);
                    label.setAttribute('y', height - padBottom + 20);
                    label.setAttribute('text-anchor', 'middle');
                    label.textContent = formatDate(data[idx].day);
                    labelGroup.appendChild(label);
                  });

                  const axisLabels = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                  axisLabels.setAttribute('fill', '#0f3f46');
                  axisLabels.setAttribute('font-size', '12');
                  axisLabels.setAttribute('font-weight', '600');

                  const xLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                  xLabel.setAttribute('x', padLeft + plotWidth / 2);
                  xLabel.setAttribute('y', height - 16);
                  xLabel.setAttribute('text-anchor', 'middle');
                  xLabel.textContent = 'Date';

                  const yLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                  yLabel.setAttribute('x', 16);
                  yLabel.setAttribute('y', padTop + plotHeight / 2);
                  yLabel.setAttribute('text-anchor', 'middle');
                  yLabel.setAttribute('transform', `rotate(-90 16 ${padTop + plotHeight / 2})`);
                  yLabel.textContent = 'Count';

                  axisLabels.appendChild(xLabel);
                  axisLabels.appendChild(yLabel);

                  const pvLine = makeLine(pvPoints, '#3C9C64');
                  const sessionLine = makeLine(sessionPoints, '#92DCE5');

                  const addDots = (key, color, labelFn) => {
                    data.forEach((d, idx) => {
                      const cx = toX(idx);
                      const cy = toY(d[key]);
                      const dot = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                      dot.setAttribute('cx', cx);
                      dot.setAttribute('cy', cy);
                      dot.setAttribute('r', '4');
                      dot.setAttribute('fill', color);
                      dot.setAttribute('aria-label', `${d.day} ${key}: ${d[key]}`);
                      dot.addEventListener('mouseenter', (evt) => showTooltip(evt, labelFn(d)));
                      dot.addEventListener('mousemove', (evt) => showTooltip(evt, labelFn(d)));
                      dot.addEventListener('mouseleave', hideTooltip);
                      svg.appendChild(dot);
                    });
                  };

                  svg.innerHTML = '';
                  svg.appendChild(tickGroup);
                  svg.appendChild(axisGroup);
                  svg.appendChild(labelGroup);
                  svg.appendChild(axisLabels);
                  svg.appendChild(sessionLine);
                  svg.appendChild(pvLine);
                  addDots('sessions', '#92DCE5', (d) => `${formatDate(d.day)} • Sessions: ${d.sessions}`);
                  addDots('page_views', '#3C9C64', (d) => `${formatDate(d.day)} • Page views: ${d.page_views}`);
                })();
              </script>
              {% else %}
              <p class="chart-empty">No data yet for this range.</p>
              {% endif %}
            </div>
          </div>
          <div class="grid gap-4 md:grid-cols-3">
            <div class="card-surface p-5">
              <div class="text-sm text-slate-600">Page views</div>
              <div class="text-3xl font-semibold text-[#0f3f46]">{{ total_page_views }}</div>
              <div class="text-xs text-slate-500">{{ range_label }}</div>
            </div>
            <div class="card-surface p-5">
              <div class="text-sm text-slate-600">Avg time on page</div>
              <div class="text-3xl font-semibold text-[#0f3f46]">{{ avg_time_label }}</div>
              <div class="text-xs text-slate-500">Page views only (m:s)</div>
            </div>
            <div class="card-surface p-5">
              <div class="text-sm text-slate-600">Unique sessions</div>
              <div class="text-3xl font-semibold text-[#0f3f46]">{{ unique_sessions }}</div>
              <div class="text-xs text-slate-500">Anonymous only</div>
            </div>
          </div>

          <div class="grid gap-4 md:grid-cols-4">
            <div class="card-surface p-5">
              <div class="text-sm text-slate-600">Rage clicks</div>
              <div class="text-3xl font-semibold text-[#0f3f46]">{{ rage_click_count }}</div>
              <div class="text-xs text-slate-500">Rapid repeated clicks</div>
            </div>
            <div class="card-surface p-5">
              <div class="text-sm text-slate-600">Dead clicks</div>
              <div class="text-3xl font-semibold text-[#0f3f46]">{{ dead_click_count }}</div>
              <div class="text-xs text-slate-500">Clicks without change</div>
            </div>
            <div class="card-surface p-5">
              <div class="text-sm text-slate-600">Avg hover dwell</div>
              <div class="text-3xl font-semibold text-[#0f3f46]">{{ avg_hover_label }}</div>
              <div class="text-xs text-slate-500">{{ hover_event_count }} hovers tracked</div>
            </div>
            <div class="card-surface p-5">
              <div class="text-sm text-slate-600">Exit rate</div>
              <div class="text-3xl font-semibold text-[#0f3f46]">{{ exit_rate }}%</div>
              <div class="text-xs text-slate-500">{{ exit_event_count }} exit events</div>
            </div>
          </div>

          <div class="card-surface p-6">
            <div class="flex items-center justify-between flex-wrap gap-3 mb-3">
              <h2 class="text-xl font-semibold text-[#0f3f46] m-0">Daily page views & sessions</h2>
              <span class="badge-muted">{{ range_label }}</span>
            </div>
            <div class="overflow-x-auto overflow-y-auto table-scroll">
              <table class="table-basic text-sm w-full">
                <thead class="text-[#0f3f46]">
                  <tr><th>Date</th><th>Views</th><th>Unique sessions</th></tr>
                </thead>
                <tbody>
                  {% for row in by_day %}
                  <tr>
                    <td>{{ row.day }}</td>
                    <td>{{ row.page_views }}</td>
                    <td>{{ row.sessions }}</td>
                  </tr>
                  {% empty %}
                  <tr><td colspan="3" class="text-slate-500 py-2">No data yet</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

          <div class="grid gap-5 md:grid-cols-2">
            <div class="card-surface p-6">
              <div class="flex items-center justify-between flex-wrap gap-3 mb-3">
                <h2 class="text-xl font-semibold text-[#0f3f46] m-0">Top pages</h2>
                <span class="badge-muted">Most viewed</span>
              </div>
              <div class="overflow-x-auto overflow-y-auto table-scroll">
                <table class="table-basic text-sm w-full">
                  <thead class="text-[#0f3f46]">
                    <tr><th>Path</th><th>Views</th><th>Avg time</th></tr>
                  </thead>
                  <tbody>
                    {% for row in top_pages %}
                    <tr>
                      <td>{{ row.path }}</td>
                      <td>{{ row.count }}</td>
                      <td>{{ row.avg_duration_label }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="3" class="text-slate-500 py-2">No data yet</td></tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>

            <div class="card-surface p-6">
              <div class="flex items-center justify-between flex-wrap gap-3 mb-3">
                <h2 class="text-xl font-semibold text-[#0f3f46] m-0">Top clicks</h2>
                <span class="badge-muted">Labels captured</span>
              </div>
              <div class="overflow-x-auto overflow-y-auto table-scroll">
                <table class="table-basic text-sm w-full">
                  <thead class="text-[#0f3f46]">
                    <tr><th>Label</th><th>Clicks</th></tr>
                  </thead>
                  <tbody>
                    {% for row in top_clicks %}
                    <tr>
                      <td>{{ row.label }}</td>
                      <td>{{ row.count }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="2" class="text-slate-500 py-2">No data yet</td></tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="grid gap-5 md:grid-cols-2">
            <div class="card-surface p-6">
              <div class="flex items-center justify-between flex-wrap gap-3 mb-3">
                <h2 class="text-xl font-semibold text-[#0f3f46] m-0">Rage click hotspots</h2>
                <span class="badge-muted">Rapid repeated clicks</span>
              </div>
              <div class="overflow-x-auto overflow-y-auto table-scroll">
                <table class="table-basic text-sm w-full">
                  <thead class="text-[#0f3f46]">
                    <tr><th>Label</th><th>Rage clicks</th></tr>
                  </thead>
                  <tbody>
                    {% for row in rage_hotspots %}
                    <tr>
                      <td>{{ row.label|default:"(no label)" }}</td>
                      <td>{{ row.count }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="2" class="text-slate-500 py-2">No rage clicks yet</td></tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>

            <div class="card-surface p-6">
              <div class="flex items-center justify-between flex-wrap gap-3 mb-3">
                <h2 class="text-xl font-semibold text-[#0f3f46] m-0">Dead click hotspots</h2>
                <span class="badge-muted">Clicks without change</span>
              </div>
              <div class="overflow-x-auto overflow-y-auto table-scroll">
                <table class="table-basic text-sm w-full">
                  <thead class="text-[#0f3f46]">
                    <tr><th>Label</th><th>Dead clicks</th></tr>
                  </thead>
                  <tbody>
                    {% for row in dead_hotspots %}
                    <tr>
                      <td>{{ row.label|default:"(no label)" }}</td>
                      <td>{{ row.count }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="2" class="text-slate-500 py-2">No dead clicks yet</td></tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="grid gap-5 md:grid-cols-2">
            <div class="card-surface p-6">
              <div class="flex items-center justify-between flex-wrap gap-3 mb-3">
                <h2 class="text-xl font-semibold text-[#0f3f46] m-0">Hover intent targets</h2>
                <span class="badge-muted">Longer dwells</span>
              </div>
              <div class="overflow-x-auto overflow-y-auto table-scroll">
                <table class="table-basic text-sm w-full">
                  <thead class="text-[#0f3f46]">
                    <tr><th>Target</th><th>Hovers</th><th>Avg dwell</th></tr>
                  </thead>
                  <tbody>
                    {% for row in hover_targets %}
                    <tr>
                      <td>{{ row.label|default:"(no label)" }}</td>
                      <td>{{ row.count }}</td>
                      <td>{{ row.avg_duration_label }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="3" class="text-slate-500 py-2">No hover intents yet</td></tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>

            <div class="card-surface p-6">
              <div class="flex items-center justify-between flex-wrap gap-3 mb-3">
                <h2 class="text-xl font-semibold text-[#0f3f46] m-0">Exit paths</h2>
                <span class="badge-muted">Where sessions end</span>
              </div>
              <div class="overflow-x-auto overflow-y-auto table-scroll">
                <table class="table-basic text-sm w-full">
                  <thead class="text-[#0f3f46]">
                    <tr><th>Path</th><th>Exits</th><th>Sessions</th><th>Avg scroll</th></tr>
                  </thead>
                  <tbody>
                    {% for row in exit_by_path %}
                    <tr>
                      <td>{{ row.path }}</td>
                      <td>{{ row.count }}</td>
                      <td>{{ row.sessions }}</td>
                      <td>{{ row.avg_scroll_label }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="4" class="text-slate-500 py-2">No exits tracked yet</td></tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="card-surface p-6">
            <div class="flex items-center justify-between flex-wrap gap-3 mb-3">
              <h2 class="text-xl font-semibold text-[#0f3f46] m-0">Click path sequences</h2>
              <span class="badge-muted">Last interactions before exit</span>
            </div>
            <div class="overflow-x-auto overflow-y-auto table-scroll">
              <table class="table-basic text-sm w-full">
                <thead class="text-[#0f3f46]">
                  <tr><th>Sequence</th><th>Occurrences</th><th>Sessions</th><th>Avg scroll</th></tr>
                </thead>
                <tbody>
                  {% for row in click_paths %}
                  <tr>
                    <td>{{ row.metadata__click_path }}</td>
                    <td>{{ row.count }}</td>
                    <td>{{ row.sessions }}</td>
                    <td>{{ row.avg_scroll_label }}</td>
                  </tr>
                  {% empty %}
                  <tr><td colspan="4" class="text-slate-500 py-2">No click paths recorded yet</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

          <div class="card-surface p-6">
            <div class="flex items-center justify-between flex-wrap gap-3 mb-3">
              <h2 class="text-xl font-semibold text-[#0f3f46] m-0">Top landing referrers</h2>
              <span class="badge-muted">By unique sessions</span>
            </div>
            <div class="overflow-x-auto overflow-y-auto table-scroll">
              <table class="table-basic text-sm w-full">
                <thead class="text-[#0f3f46]">
                  <tr><th>Referrer</th><th>Sessions</th><th>Events</th></tr>
                </thead>
                <tbody>
                  {% for row in landing_referrers %}
                  <tr>
                    <td>{{ row.metadata__landing_referrer|default:"Direct / none" }}</td>
                    <td>{{ row.sessions }}</td>
                    <td>{{ row.events }}</td>
                  </tr>
                  {% empty %}
                  <tr><td colspan="3" class="text-slate-500 py-2">No referrers captured yet</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

            <div class="grid gap-4 md:grid-cols-2">
              <div class="card-surface p-5">
                <div class="text-sm text-slate-600">Auth successes</div>
                <div class="text-3xl font-semibold text-[#0f3f46]">{{ auth_successes }}</div>
                <div class="text-xs text-slate-500">Logins (all users)</div>
              </div>
              <div class="card-surface p-5">
                <div class="text-sm text-slate-600">Auth failures</div>
                <div class="text-3xl font-semibold text-[#0f3f46]">{{ auth_failures }}</div>
                <div class="text-xs text-slate-500">Failed login attempts</div>
              </div>
            </div>

          <div class="card-surface p-6">
            <div class="flex items-center justify-between flex-wrap gap-3 mb-3">
              <h2 class="text-xl font-semibold text-[#0f3f46] m-0">Top locations</h2>
              <span class="badge-muted">By event count</span>
            </div>
            <div class="overflow-x-auto overflow-y-auto table-scroll">
              <table class="table-basic text-sm w-full">
                <thead class="text-[#0f3f46]">
                  <tr><th>Country</th><th>Region/State</th><th>City</th><th>Timezone</th><th>Events</th><th>Sessions</th></tr>
                </thead>
                <tbody>
                  {% for row in locations %}
                  <tr>
                    <td>{{ row.country_code|upper }}</td>
                    <td>{{ row.region }}</td>
                    <td>{{ row.city }}</td>
                    <td>{{ row.timezone }}</td>
                    <td>{{ row.count }}</td>
                    <td>{{ row.sessions }}</td>
                  </tr>
                  {% empty %}
                  <tr><td colspan="6" class="text-slate-500 py-2">No location data captured yet</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

          <div class="card-surface p-6">
            <div class="flex items-center justify-between flex-wrap gap-3 mb-3">
              <h2 class="text-xl font-semibold text-[#0f3f46] m-0">Recent failed logins</h2>
              <span class="badge-muted">Last 20</span>
            </div>
            <div class="overflow-x-auto overflow-y-auto table-scroll">
              <table class="table-basic text-sm w-full">
                <thead class="text-[#0f3f46]">
                  <tr><th>When</th><th>Path</th><th>Region/City</th><th>Timezone</th><th>User agent</th><th>Referrer</th></tr>
                </thead>
                <tbody>
                  {% for row in recent_failures %}
                  <tr>
                    <td>{{ row.created|date:"Y-m-d H:i" }}</td>
                    <td>{{ row.path }}</td>
                    <td>{{ row.region }}{% if row.region and row.city %}, {% endif %}{{ row.city }}</td>
                    <td>{{ row.timezone }}</td>
                    <td>{{ row.user_agent|truncatechars:60 }}</td>
                    <td>{{ row.referrer|default:""|truncatechars:40 }}</td>
                  </tr>
                  {% empty %}
                  <tr><td colspan="6" class="text-slate-500 py-2">No failed logins yet</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

          <div class="card-surface p-6 flex items-center justify-between flex-wrap gap-3">
            <div>
              <h2 class="text-xl font-semibold text-[#0f3f46] m-0">Average scroll depth</h2>
              <p class="text-slate-600 text-sm m-0">Across scroll events</p>
            </div>
            <div class="text-3xl font-semibold text-[#0f3f46]">{{ avg_scroll|floatformat:0 }}%</div>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>
{% endblock %}

{% block before_footer %}
  <div aria-hidden="true" class="w-full bg-brand-deep h-16"></div>
{% endblock %}
