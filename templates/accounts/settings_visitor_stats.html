{% extends "base.html" %}
{% block title %}Visitor Stats | L+C Psych{% endblock %}

{% block head_extra %}
{% include "accounts/partials/settings_nav_styles.html" %}
<style>
.card-surface { background: #fff; border-radius: 1.25rem; box-shadow: 0 15px 40px rgba(0, 48, 57, 0.05); border: 1px solid rgba(146, 220, 229, 0.35); }
.table-basic th, .table-basic td { padding: 0.6rem 0.4rem; border-bottom: 1px solid rgba(15, 63, 70, 0.08); }
.badge-muted { display: inline-block; padding: 0.2rem 0.6rem; border-radius: 999px; background: rgba(146, 220, 229, 0.22); color: #0f3f46; font-weight: 700; font-size: 0.8rem; }
.date-field { appearance: none; -webkit-appearance: none; border-radius: 0.75rem; border: 1px solid rgba(15, 63, 70, 0.14); padding: 0.55rem 0.75rem; font-size: 0.95rem; color: #0f3f46; box-shadow: inset 0 1px 0 rgba(255,255,255,0.7); }
.date-field:focus { outline: none; border-color: #92DCE5; box-shadow: 0 0 0 3px rgba(146, 220, 229, 0.45); }
.preset-btn { border: 1px solid rgba(15, 63, 70, 0.14); border-radius: 999px; padding: 0.4rem 0.9rem; font-weight: 600; color: #0f3f46; background: #f7f9f9; transition: all 0.15s ease; }
.preset-btn:hover { border-color: #92DCE5; color: #005F6B; background: #ecf8fa; }
.chart-legend { display: flex; gap: 12px; align-items: center; font-size: 0.95rem; color: #0f3f46; }
.legend-chip { display: inline-flex; align-items: center; gap: 8px; }
.legend-dot { width: 12px; height: 12px; border-radius: 50%; }
.legend-dot.sessions { background: #92DCE5; }
.legend-dot.views { background: #3C9C64; }
.line-chart-wrapper { position: relative; width: 100%; overflow: hidden; }
.line-chart { width: 100%; height: 240px; }
.chart-empty { color: #475569; font-size: 0.95rem; }
</style>
{% endblock %}

{% block content %}
<main id="content">
  <section class="relative overflow-hidden z-10 bg-brand-deep text-white pb-12 pt-14">
    <div class="max-w-[1100px] mx-auto px-4 text-center">
      <h1 class="text-4xl leading-tight font-semibold m-0">Visitor stats</h1>
      <p class="mt-3 mx-auto max-w-[760px] text-white/90 text-lg">Anonymous sessions only, {{ range_label }} ({{ range_days }} days).</p>
    </div>
  </section>

  <section class="relative z-20 py-10 md:py-14 bg-brand-accent">
    <div class="elementor-1393">
      <div class="elementor-element elementor-element-a80adf4">
        <div class="e-con-inner">
          <div class="elementor-shape elementor-shape-top" aria-hidden="true" data-negative="false">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 283.5 27.8" preserveAspectRatio="none">
              <path class="elementor-shape-fill" d="M283.5,9.7c0,0-7.3,4.3-14,4.6c-6.8,0.3-12.6,0-20.9-1.5c-11.3-2-33.1-10.1-44.7-5.7 s-12.1,4.6-18,7.4c-6.6,3.2-20,9.6-36.6,9.3C131.6,23.5,99.5,7.2,86.3,8c-1.4,0.1-6.6,0.8-10.5,2c-3.8,1.2-9.4,3.8-17,4.7 c-3.2,0.4-8.3,1.1-14.2,0.9c-1.5-0.1-6.3-0.4-12-1.6c-5.7-1.2-11-3.1-15.8-3.7C6.5,9.2,0,10.8,0,10.8V0h283.5V9.7z" />
            </svg>
          </div>
          <div class="elementor-shape elementor-shape-bottom" aria-hidden="true" data-negative="false">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 283.5 27.8" preserveAspectRatio="none">
              <path class="elementor-shape-fill" d="M283.5,9.7c0,0-7.3,4.3-14,4.6c-6.8,0.3-12.6,0-20.9-1.5c-11.3-2-33.1-10.1-44.7-5.7 s-12.1,4.6-18,7.4c-6.6,3.2-20,9.6-36.6,9.3C131.6,23.5,99.5,7.2,86.3,8c-1.4,0.1-6.6,0.8-10.5,2c-3.8,1.2-9.4,3.8-17,4.7 c-3.2,0.4-8.3,1.1-14.2,0.9c-1.5-0.1-6.3-0.4-12-1.6c-5.7-1.2-11-3.1-15.8-3.7C6.5,9.2,0,10.8,0,10.8V0h283.5V9.7z" />
            </svg>
          </div>
        </div>
      </div>
    </div>
    <div class="max-w-[1200px] mx-auto px-4">
      <div class="settings-layout">
        {% include "accounts/partials/settings_nav.html" with active_page="visitor_stats" %}

        <div class="space-y-6">
          <div class="card-surface p-6">
            <form class="flex flex-wrap gap-4 items-end" method="get">
              <div>
                <label class="block text-sm font-semibold text-[#0f3f46] mb-1" for="start">Start date</label>
                <input id="start" name="start" type="date" value="{{ start_date|date:'Y-m-d' }}" class="date-field">
              </div>
              <div>
                <label class="block text-sm font-semibold text-[#0f3f46] mb-1" for="end">End date</label>
                <input id="end" name="end" type="date" value="{{ end_date|date:'Y-m-d' }}" class="date-field">
              </div>
              <div class="flex flex-wrap gap-2 items-center">
                <button type="button" class="preset-btn" data-days="7">7d</button>
                <button type="button" class="preset-btn" data-days="30">30d</button>
                <button type="button" class="preset-btn" data-days="90">90d</button>
                <button type="button" class="preset-btn" data-days="180">180d</button>
                <button type="button" class="preset-btn" data-days="365">365d</button>
              </div>
              <div class="flex-1 min-w-[160px] text-sm text-slate-600">
                <span>Up to past 365 days. Default is last 30 days.</span>
              </div>
              <button type="submit" class="inline-flex items-center justify-center px-4 py-2 rounded-lg bg-[#3C9C64] text-white font-semibold hover:bg-[#92DCE5] hover:text-[#005F6B] transition-colors">Update range</button>
            </form>
          </div>

          <div class="card-surface p-6">
            <div class="flex items-center justify-between flex-wrap gap-3 mb-3">
              <h2 class="text-xl font-semibold text-[#0f3f46] m-0">Sessions vs page views</h2>
              <div class="chart-legend">
                <span class="legend-chip"><span class="legend-dot sessions"></span>Sessions</span>
                <span class="legend-chip"><span class="legend-dot views"></span>Page views</span>
              </div>
            </div>
            <div class="line-chart-wrapper">
              {% if chart_by_day %}
              {{ chart_by_day|json_script:"chart-data" }}
              <svg id="line-chart" class="line-chart" role="img" aria-label="Sessions and page views by day"></svg>
              <script>
                (() => {
                  const script = document.getElementById('chart-data');
                  if (!script) return;
                  const data = JSON.parse(script.textContent || '[]');
                  const svg = document.getElementById('line-chart');
                  if (!svg || !data.length) return;

                  const padX = 28;
                  const padY = 18;
                  const width = svg.clientWidth || svg.parentElement.clientWidth;
                  const height = svg.clientHeight || 240;
                  svg.setAttribute('viewBox', `0 0 ${width} ${height}`);

                  const maxVal = Math.max(...data.map(d => Math.max(d.sessions, d.page_views, 1)));
                  const stepX = data.length > 1 ? (width - padX * 2) / (data.length - 1) : 0;

                  const toY = (val) => {
                    const pct = val / maxVal;
                    return padY + (1 - pct) * (height - padY * 2);
                  };

                  const buildPoints = (key) => data.map((d, idx) => `${padX + idx * stepX},${toY(d[key])}`).join(' ');

                  const pvPoints = buildPoints('page_views');
                  const sessionPoints = buildPoints('sessions');

                  const makeLine = (points, color) => {
                    const el = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
                    el.setAttribute('points', points);
                    el.setAttribute('fill', 'none');
                    el.setAttribute('stroke', color);
                    el.setAttribute('stroke-width', '3');
                    el.setAttribute('stroke-linecap', 'round');
                    el.setAttribute('stroke-linejoin', 'round');
                    return el;
                  };

                  const pvLine = makeLine(pvPoints, '#3C9C64');
                  const sessionLine = makeLine(sessionPoints, '#92DCE5');

                  const addDots = (key, color) => {
                    data.forEach((d, idx) => {
                      const cx = padX + idx * stepX;
                      const cy = toY(d[key]);
                      const dot = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                      dot.setAttribute('cx', cx);
                      dot.setAttribute('cy', cy);
                      dot.setAttribute('r', '4');
                      dot.setAttribute('fill', color);
                      dot.setAttribute('aria-label', `${d.day} ${key}: ${d[key]}`);
                      svg.appendChild(dot);
                    });
                  };

                  svg.innerHTML = '';
                  svg.appendChild(sessionLine);
                  svg.appendChild(pvLine);
                  addDots('sessions', '#92DCE5');
                  addDots('page_views', '#3C9C64');
                })();
              </script>
              {% else %}
              <p class="chart-empty">No data yet for this range.</p>
              {% endif %}
            </div>
          </div>
          <div class="grid gap-4 md:grid-cols-3">
            <div class="card-surface p-5">
              <div class="text-sm text-slate-600">Page views</div>
              <div class="text-3xl font-semibold text-[#0f3f46]">{{ total_page_views }}</div>
              <div class="text-xs text-slate-500">{{ range_label }}</div>
            </div>
            <div class="card-surface p-5">
              <div class="text-sm text-slate-600">Avg time on page</div>
              <div class="text-3xl font-semibold text-[#0f3f46]">{{ avg_time_label }}</div>
              <div class="text-xs text-slate-500">Page views only (m:s)</div>
            </div>
            <div class="card-surface p-5">
              <div class="text-sm text-slate-600">Unique sessions</div>
              <div class="text-3xl font-semibold text-[#0f3f46]">{{ unique_sessions }}</div>
              <div class="text-xs text-slate-500">Anonymous only</div>
            </div>
          </div>

          <div class="grid gap-4 md:grid-cols-4">
            <div class="card-surface p-5">
              <div class="text-sm text-slate-600">Rage clicks</div>
              <div class="text-3xl font-semibold text-[#0f3f46]">{{ rage_click_count }}</div>
              <div class="text-xs text-slate-500">Rapid repeated clicks</div>
            </div>
            <div class="card-surface p-5">
              <div class="text-sm text-slate-600">Dead clicks</div>
              <div class="text-3xl font-semibold text-[#0f3f46]">{{ dead_click_count }}</div>
              <div class="text-xs text-slate-500">Clicks without change</div>
            </div>
            <div class="card-surface p-5">
              <div class="text-sm text-slate-600">Avg hover dwell</div>
              <div class="text-3xl font-semibold text-[#0f3f46]">{{ avg_hover_label }}</div>
              <div class="text-xs text-slate-500">{{ hover_event_count }} hovers tracked</div>
            </div>
            <div class="card-surface p-5">
              <div class="text-sm text-slate-600">Exit rate</div>
              <div class="text-3xl font-semibold text-[#0f3f46]">{{ exit_rate }}%</div>
              <div class="text-xs text-slate-500">{{ exit_event_count }} exit events</div>
            </div>
          </div>

          <div class="card-surface p-6">
            <div class="flex items-center justify-between flex-wrap gap-3 mb-3">
              <h2 class="text-xl font-semibold text-[#0f3f46] m-0">Daily page views</h2>
              <span class="badge-muted">{{ range_label }}</span>
            </div>
            <div class="overflow-x-auto">
              <table class="table-basic text-sm w-full">
                <thead class="text-[#0f3f46]">
                  <tr><th>Date</th><th>Views</th></tr>
                </thead>
                <tbody>
                  {% for row in by_day %}
                  <tr>
                    <td>{{ row.day }}</td>
                    <td>{{ row.count }}</td>
                  </tr>
                  {% empty %}
                  <tr><td colspan="2" class="text-slate-500 py-2">No data yet</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

          <div class="grid gap-5 md:grid-cols-2">
            <div class="card-surface p-6">
              <div class="flex items-center justify-between flex-wrap gap-3 mb-3">
                <h2 class="text-xl font-semibold text-[#0f3f46] m-0">Top pages</h2>
                <span class="badge-muted">Most viewed</span>
              </div>
              <div class="overflow-x-auto">
                <table class="table-basic text-sm w-full">
                  <thead class="text-[#0f3f46]">
                    <tr><th>Path</th><th>Views</th><th>Avg time</th></tr>
                  </thead>
                  <tbody>
                    {% for row in top_pages %}
                    <tr>
                      <td>{{ row.path }}</td>
                      <td>{{ row.count }}</td>
                      <td>{{ row.avg_duration_label }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="3" class="text-slate-500 py-2">No data yet</td></tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>

            <div class="card-surface p-6">
              <div class="flex items-center justify-between flex-wrap gap-3 mb-3">
                <h2 class="text-xl font-semibold text-[#0f3f46] m-0">Top clicks</h2>
                <span class="badge-muted">Labels captured</span>
              </div>
              <div class="overflow-x-auto">
                <table class="table-basic text-sm w-full">
                  <thead class="text-[#0f3f46]">
                    <tr><th>Label</th><th>Clicks</th></tr>
                  </thead>
                  <tbody>
                    {% for row in top_clicks %}
                    <tr>
                      <td>{{ row.label }}</td>
                      <td>{{ row.count }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="2" class="text-slate-500 py-2">No data yet</td></tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="grid gap-5 md:grid-cols-2">
            <div class="card-surface p-6">
              <div class="flex items-center justify-between flex-wrap gap-3 mb-3">
                <h2 class="text-xl font-semibold text-[#0f3f46] m-0">Rage click hotspots</h2>
                <span class="badge-muted">Rapid repeated clicks</span>
              </div>
              <div class="overflow-x-auto">
                <table class="table-basic text-sm w-full">
                  <thead class="text-[#0f3f46]">
                    <tr><th>Label</th><th>Rage clicks</th></tr>
                  </thead>
                  <tbody>
                    {% for row in rage_hotspots %}
                    <tr>
                      <td>{{ row.label|default:"(no label)" }}</td>
                      <td>{{ row.count }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="2" class="text-slate-500 py-2">No rage clicks yet</td></tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>

            <div class="card-surface p-6">
              <div class="flex items-center justify-between flex-wrap gap-3 mb-3">
                <h2 class="text-xl font-semibold text-[#0f3f46] m-0">Dead click hotspots</h2>
                <span class="badge-muted">Clicks without change</span>
              </div>
              <div class="overflow-x-auto">
                <table class="table-basic text-sm w-full">
                  <thead class="text-[#0f3f46]">
                    <tr><th>Label</th><th>Dead clicks</th></tr>
                  </thead>
                  <tbody>
                    {% for row in dead_hotspots %}
                    <tr>
                      <td>{{ row.label|default:"(no label)" }}</td>
                      <td>{{ row.count }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="2" class="text-slate-500 py-2">No dead clicks yet</td></tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="grid gap-5 md:grid-cols-2">
            <div class="card-surface p-6">
              <div class="flex items-center justify-between flex-wrap gap-3 mb-3">
                <h2 class="text-xl font-semibold text-[#0f3f46] m-0">Hover intent targets</h2>
                <span class="badge-muted">Longer dwells</span>
              </div>
              <div class="overflow-x-auto">
                <table class="table-basic text-sm w-full">
                  <thead class="text-[#0f3f46]">
                    <tr><th>Target</th><th>Hovers</th><th>Avg dwell</th></tr>
                  </thead>
                  <tbody>
                    {% for row in hover_targets %}
                    <tr>
                      <td>{{ row.label|default:"(no label)" }}</td>
                      <td>{{ row.count }}</td>
                      <td>{{ row.avg_duration_label }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="3" class="text-slate-500 py-2">No hover intents yet</td></tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>

            <div class="card-surface p-6">
              <div class="flex items-center justify-between flex-wrap gap-3 mb-3">
                <h2 class="text-xl font-semibold text-[#0f3f46] m-0">Exit paths</h2>
                <span class="badge-muted">Where sessions end</span>
              </div>
              <div class="overflow-x-auto">
                <table class="table-basic text-sm w-full">
                  <thead class="text-[#0f3f46]">
                    <tr><th>Path</th><th>Exits</th><th>Sessions</th><th>Avg scroll</th></tr>
                  </thead>
                  <tbody>
                    {% for row in exit_by_path %}
                    <tr>
                      <td>{{ row.path }}</td>
                      <td>{{ row.count }}</td>
                      <td>{{ row.sessions }}</td>
                      <td>{{ row.avg_scroll_label }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="4" class="text-slate-500 py-2">No exits tracked yet</td></tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="card-surface p-6">
            <div class="flex items-center justify-between flex-wrap gap-3 mb-3">
              <h2 class="text-xl font-semibold text-[#0f3f46] m-0">Click path sequences</h2>
              <span class="badge-muted">Last interactions before exit</span>
            </div>
            <div class="overflow-x-auto">
              <table class="table-basic text-sm w-full">
                <thead class="text-[#0f3f46]">
                  <tr><th>Sequence</th><th>Occurrences</th><th>Sessions</th><th>Avg scroll</th></tr>
                </thead>
                <tbody>
                  {% for row in click_paths %}
                  <tr>
                    <td>{{ row.metadata__click_path }}</td>
                    <td>{{ row.count }}</td>
                    <td>{{ row.sessions }}</td>
                    <td>{{ row.avg_scroll_label }}</td>
                  </tr>
                  {% empty %}
                  <tr><td colspan="4" class="text-slate-500 py-2">No click paths recorded yet</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

          <div class="card-surface p-6">
            <div class="flex items-center justify-between flex-wrap gap-3 mb-3">
              <h2 class="text-xl font-semibold text-[#0f3f46] m-0">Top landing referrers</h2>
              <span class="badge-muted">By unique sessions</span>
            </div>
            <div class="overflow-x-auto">
              <table class="table-basic text-sm w-full">
                <thead class="text-[#0f3f46]">
                  <tr><th>Referrer</th><th>Sessions</th><th>Events</th></tr>
                </thead>
                <tbody>
                  {% for row in landing_referrers %}
                  <tr>
                    <td>{{ row.metadata__landing_referrer|default:"Direct / none" }}</td>
                    <td>{{ row.sessions }}</td>
                    <td>{{ row.events }}</td>
                  </tr>
                  {% empty %}
                  <tr><td colspan="3" class="text-slate-500 py-2">No referrers captured yet</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

            <div class="grid gap-4 md:grid-cols-2">
              <div class="card-surface p-5">
                <div class="text-sm text-slate-600">Auth successes</div>
                <div class="text-3xl font-semibold text-[#0f3f46]">{{ auth_successes }}</div>
                <div class="text-xs text-slate-500">Logins (all users)</div>
              </div>
              <div class="card-surface p-5">
                <div class="text-sm text-slate-600">Auth failures</div>
                <div class="text-3xl font-semibold text-[#0f3f46]">{{ auth_failures }}</div>
                <div class="text-xs text-slate-500">Failed login attempts</div>
              </div>
            </div>

          <div class="card-surface p-6">
            <div class="flex items-center justify-between flex-wrap gap-3 mb-3">
              <h2 class="text-xl font-semibold text-[#0f3f46] m-0">Top locations</h2>
              <span class="badge-muted">By event count</span>
            </div>
            <div class="overflow-x-auto">
              <table class="table-basic text-sm w-full">
                <thead class="text-[#0f3f46]">
                  <tr><th>Country</th><th>Region/State</th><th>City</th><th>Timezone</th><th>Events</th><th>Sessions</th></tr>
                </thead>
                <tbody>
                  {% for row in locations %}
                  <tr>
                    <td>{{ row.country_code|upper }}</td>
                    <td>{{ row.region }}</td>
                    <td>{{ row.city }}</td>
                    <td>{{ row.timezone }}</td>
                    <td>{{ row.count }}</td>
                    <td>{{ row.sessions }}</td>
                  </tr>
                  {% empty %}
                  <tr><td colspan="6" class="text-slate-500 py-2">No location data captured yet</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

          <div class="card-surface p-6">
            <div class="flex items-center justify-between flex-wrap gap-3 mb-3">
              <h2 class="text-xl font-semibold text-[#0f3f46] m-0">Recent failed logins</h2>
              <span class="badge-muted">Last 20</span>
            </div>
            <div class="overflow-x-auto">
              <table class="table-basic text-sm w-full">
                <thead class="text-[#0f3f46]">
                  <tr><th>When</th><th>Path</th><th>Region/City</th><th>Timezone</th><th>User agent</th><th>Referrer</th></tr>
                </thead>
                <tbody>
                  {% for row in recent_failures %}
                  <tr>
                    <td>{{ row.created|date:"Y-m-d H:i" }}</td>
                    <td>{{ row.path }}</td>
                    <td>{{ row.region }}{% if row.region and row.city %}, {% endif %}{{ row.city }}</td>
                    <td>{{ row.timezone }}</td>
                    <td>{{ row.user_agent|truncatechars:60 }}</td>
                    <td>{{ row.referrer|default:""|truncatechars:40 }}</td>
                  </tr>
                  {% empty %}
                  <tr><td colspan="6" class="text-slate-500 py-2">No failed logins yet</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

          <div class="card-surface p-6 flex items-center justify-between flex-wrap gap-3">
            <div>
              <h2 class="text-xl font-semibold text-[#0f3f46] m-0">Average scroll depth</h2>
              <p class="text-slate-600 text-sm m-0">Across scroll events</p>
            </div>
            <div class="text-3xl font-semibold text-[#0f3f46]">{{ avg_scroll|floatformat:0 }}%</div>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>
{% endblock %}

{% block before_footer %}
  <div aria-hidden="true" class="w-full bg-brand-deep h-16"></div>
{% endblock %}
