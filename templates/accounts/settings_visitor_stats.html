{% extends "base.html" %}
{% block title %}Visitor Stats | L+C Psych{% endblock %}

{% block head_extra %}
{% include "accounts/partials/settings_nav_styles.html" %}
<style>
.card-surface { background: #fff; border-radius: 1.25rem; box-shadow: 0 15px 40px rgba(0, 48, 57, 0.05); border: 1px solid rgba(146, 220, 229, 0.35); }
.table-basic th, .table-basic td { padding: 0.6rem 0.4rem; border-bottom: 1px solid rgba(15, 63, 70, 0.08); }
.badge-muted { display: inline-block; padding: 0.2rem 0.6rem; border-radius: 999px; background: rgba(146, 220, 229, 0.22); color: #0f3f46; font-weight: 700; font-size: 0.8rem; }
.chart-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(58px, 1fr)); gap: 10px; align-items: end; }
.chart-bar { display: flex; flex-direction: column; align-items: center; gap: 6px; }
.chart-bar-stack { display: grid; gap: 4px; width: 100%; height: 180px; align-items: end; }
.chart-bar-stack .bar { border-radius: 10px; width: 100%; min-height: 2px; }
.chart-bar-stack .bar.pv { background: #3C9C64; }
.chart-bar-stack .bar.sessions { background: #92DCE5; }
.chart-label { font-size: 0.75rem; color: #0f3f46; text-align: center; white-space: nowrap; }
</style>
{% endblock %}

{% block content %}
<main id="content">
  <section class="relative overflow-hidden z-10 bg-brand-deep text-white pb-12 pt-14">
    <div class="max-w-[1100px] mx-auto px-4 text-center">
      <h1 class="text-4xl leading-tight font-semibold m-0">Visitor stats</h1>
      <p class="mt-3 mx-auto max-w-[760px] text-white/90 text-lg">Anonymous sessions only, {{ range_label }} ({{ range_days }} days).</p>
    </div>
  </section>

  <section class="relative z-20 py-10 md:py-14 bg-brand-accent">
    <div class="elementor-1393">
      <div class="elementor-element elementor-element-a80adf4">
        <div class="e-con-inner">
          <div class="elementor-shape elementor-shape-top" aria-hidden="true" data-negative="false">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 283.5 27.8" preserveAspectRatio="none">
              <path class="elementor-shape-fill" d="M283.5,9.7c0,0-7.3,4.3-14,4.6c-6.8,0.3-12.6,0-20.9-1.5c-11.3-2-33.1-10.1-44.7-5.7 s-12.1,4.6-18,7.4c-6.6,3.2-20,9.6-36.6,9.3C131.6,23.5,99.5,7.2,86.3,8c-1.4,0.1-6.6,0.8-10.5,2c-3.8,1.2-9.4,3.8-17,4.7 c-3.2,0.4-8.3,1.1-14.2,0.9c-1.5-0.1-6.3-0.4-12-1.6c-5.7-1.2-11-3.1-15.8-3.7C6.5,9.2,0,10.8,0,10.8V0h283.5V9.7z" />
            </svg>
          </div>
          <div class="elementor-shape elementor-shape-bottom" aria-hidden="true" data-negative="false">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 283.5 27.8" preserveAspectRatio="none">
              <path class="elementor-shape-fill" d="M283.5,9.7c0,0-7.3,4.3-14,4.6c-6.8,0.3-12.6,0-20.9-1.5c-11.3-2-33.1-10.1-44.7-5.7 s-12.1,4.6-18,7.4c-6.6,3.2-20,9.6-36.6,9.3C131.6,23.5,99.5,7.2,86.3,8c-1.4,0.1-6.6,0.8-10.5,2c-3.8,1.2-9.4,3.8-17,4.7 c-3.2,0.4-8.3,1.1-14.2,0.9c-1.5-0.1-6.3-0.4-12-1.6c-5.7-1.2-11-3.1-15.8-3.7C6.5,9.2,0,10.8,0,10.8V0h283.5V9.7z" />
            </svg>
          </div>
        </div>
      </div>
    </div>
    <div class="max-w-[1200px] mx-auto px-4">
      <div class="settings-layout">
        {% include "accounts/partials/settings_nav.html" with active_page="visitor_stats" %}

        <div class="space-y-6">
          <div class="card-surface p-6">
            <form class="flex flex-wrap gap-4 items-end" method="get">
              <div>
                <label class="block text-sm font-semibold text-[#0f3f46] mb-1" for="start">Start date</label>
                <input id="start" name="start" type="date" value="{{ start_date|date:'Y-m-d' }}" class="rounded-lg border border-slate-300 px-3 py-2 text-sm text-[#0f3f46] shadow-sm focus:border-[#92DCE5] focus:ring-2 focus:ring-[#92DCE5]">
              </div>
              <div>
                <label class="block text-sm font-semibold text-[#0f3f46] mb-1" for="end">End date</label>
                <input id="end" name="end" type="date" value="{{ end_date|date:'Y-m-d' }}" class="rounded-lg border border-slate-300 px-3 py-2 text-sm text-[#0f3f46] shadow-sm focus:border-[#92DCE5] focus:ring-2 focus:ring-[#92DCE5]">
              </div>
              <div class="flex-1 min-w-[160px]">
                <span class="text-sm text-slate-600">Up to past 365 days. Default is last 30 days.</span>
              </div>
              <button type="submit" class="inline-flex items-center justify-center px-4 py-2 rounded-lg bg-[#3C9C64] text-white font-semibold hover:bg-[#92DCE5] hover:text-[#005F6B] transition-colors">Update range</button>
            </form>
          </div>

          <div class="card-surface p-6">
            <div class="flex items-center justify-between flex-wrap gap-3 mb-3">
              <h2 class="text-xl font-semibold text-[#0f3f46] m-0">Sessions vs page views</h2>
              <div class="flex items-center gap-3 text-sm text-slate-600">
                <span class="inline-flex items-center gap-2"><span class="inline-block h-3 w-3 rounded-full bg-[#92DCE5]"></span>Sessions</span>
                <span class="inline-flex items-center gap-2"><span class="inline-block h-3 w-3 rounded-full bg-[#3C9C64]"></span>Page views</span>
              </div>
            </div>
            <div class="chart-grid">
              {% for row in chart_by_day %}
              <div class="chart-bar">
                <div class="chart-bar-stack">
                  <div class="bar sessions" style="height: {{ row.sessions_pct }}%" title="{{ row.day }} · Sessions: {{ row.sessions }}"></div>
                  <div class="bar pv" style="height: {{ row.page_views_pct }}%" title="{{ row.day }} · Page views: {{ row.page_views }}"></div>
                </div>
                <div class="chart-label">{{ row.day|date:"M j" }}</div>
              </div>
              {% empty %}
              <p class="text-slate-500">No data yet for this range.</p>
              {% endfor %}
            </div>
          </div>
          <div class="grid gap-4 md:grid-cols-3">
            <div class="card-surface p-5">
              <div class="text-sm text-slate-600">Page views</div>
              <div class="text-3xl font-semibold text-[#0f3f46]">{{ total_page_views }}</div>
              <div class="text-xs text-slate-500">{{ range_label }}</div>
            </div>
            <div class="card-surface p-5">
              <div class="text-sm text-slate-600">Avg time on page</div>
              <div class="text-3xl font-semibold text-[#0f3f46]">{{ avg_time_label }}</div>
              <div class="text-xs text-slate-500">Page views only (m:s)</div>
            </div>
            <div class="card-surface p-5">
              <div class="text-sm text-slate-600">Unique sessions</div>
              <div class="text-3xl font-semibold text-[#0f3f46]">{{ unique_sessions }}</div>
              <div class="text-xs text-slate-500">Anonymous only</div>
            </div>
          </div>

          <div class="grid gap-4 md:grid-cols-4">
            <div class="card-surface p-5">
              <div class="text-sm text-slate-600">Rage clicks</div>
              <div class="text-3xl font-semibold text-[#0f3f46]">{{ rage_click_count }}</div>
              <div class="text-xs text-slate-500">Rapid repeated clicks</div>
            </div>
            <div class="card-surface p-5">
              <div class="text-sm text-slate-600">Dead clicks</div>
              <div class="text-3xl font-semibold text-[#0f3f46]">{{ dead_click_count }}</div>
              <div class="text-xs text-slate-500">Clicks without change</div>
            </div>
            <div class="card-surface p-5">
              <div class="text-sm text-slate-600">Avg hover dwell</div>
              <div class="text-3xl font-semibold text-[#0f3f46]">{{ avg_hover_label }}</div>
              <div class="text-xs text-slate-500">{{ hover_event_count }} hovers tracked</div>
            </div>
            <div class="card-surface p-5">
              <div class="text-sm text-slate-600">Exit rate</div>
              <div class="text-3xl font-semibold text-[#0f3f46]">{{ exit_rate }}%</div>
              <div class="text-xs text-slate-500">{{ exit_event_count }} exit events</div>
            </div>
          </div>

          <div class="card-surface p-6">
            <div class="flex items-center justify-between flex-wrap gap-3 mb-3">
              <h2 class="text-xl font-semibold text-[#0f3f46] m-0">Daily page views</h2>
              <span class="badge-muted">{{ range_label }}</span>
            </div>
            <div class="overflow-x-auto">
              <table class="table-basic text-sm w-full">
                <thead class="text-[#0f3f46]">
                  <tr><th>Date</th><th>Views</th></tr>
                </thead>
                <tbody>
                  {% for row in by_day %}
                  <tr>
                    <td>{{ row.day }}</td>
                    <td>{{ row.count }}</td>
                  </tr>
                  {% empty %}
                  <tr><td colspan="2" class="text-slate-500 py-2">No data yet</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

          <div class="grid gap-5 md:grid-cols-2">
            <div class="card-surface p-6">
              <div class="flex items-center justify-between flex-wrap gap-3 mb-3">
                <h2 class="text-xl font-semibold text-[#0f3f46] m-0">Top pages</h2>
                <span class="badge-muted">Most viewed</span>
              </div>
              <div class="overflow-x-auto">
                <table class="table-basic text-sm w-full">
                  <thead class="text-[#0f3f46]">
                    <tr><th>Path</th><th>Views</th><th>Avg time</th></tr>
                  </thead>
                  <tbody>
                    {% for row in top_pages %}
                    <tr>
                      <td>{{ row.path }}</td>
                      <td>{{ row.count }}</td>
                      <td>{{ row.avg_duration_label }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="3" class="text-slate-500 py-2">No data yet</td></tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>

            <div class="card-surface p-6">
              <div class="flex items-center justify-between flex-wrap gap-3 mb-3">
                <h2 class="text-xl font-semibold text-[#0f3f46] m-0">Top clicks</h2>
                <span class="badge-muted">Labels captured</span>
              </div>
              <div class="overflow-x-auto">
                <table class="table-basic text-sm w-full">
                  <thead class="text-[#0f3f46]">
                    <tr><th>Label</th><th>Clicks</th></tr>
                  </thead>
                  <tbody>
                    {% for row in top_clicks %}
                    <tr>
                      <td>{{ row.label }}</td>
                      <td>{{ row.count }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="2" class="text-slate-500 py-2">No data yet</td></tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="grid gap-5 md:grid-cols-2">
            <div class="card-surface p-6">
              <div class="flex items-center justify-between flex-wrap gap-3 mb-3">
                <h2 class="text-xl font-semibold text-[#0f3f46] m-0">Rage click hotspots</h2>
                <span class="badge-muted">Rapid repeated clicks</span>
              </div>
              <div class="overflow-x-auto">
                <table class="table-basic text-sm w-full">
                  <thead class="text-[#0f3f46]">
                    <tr><th>Label</th><th>Rage clicks</th></tr>
                  </thead>
                  <tbody>
                    {% for row in rage_hotspots %}
                    <tr>
                      <td>{{ row.label|default:"(no label)" }}</td>
                      <td>{{ row.count }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="2" class="text-slate-500 py-2">No rage clicks yet</td></tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>

            <div class="card-surface p-6">
              <div class="flex items-center justify-between flex-wrap gap-3 mb-3">
                <h2 class="text-xl font-semibold text-[#0f3f46] m-0">Dead click hotspots</h2>
                <span class="badge-muted">Clicks without change</span>
              </div>
              <div class="overflow-x-auto">
                <table class="table-basic text-sm w-full">
                  <thead class="text-[#0f3f46]">
                    <tr><th>Label</th><th>Dead clicks</th></tr>
                  </thead>
                  <tbody>
                    {% for row in dead_hotspots %}
                    <tr>
                      <td>{{ row.label|default:"(no label)" }}</td>
                      <td>{{ row.count }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="2" class="text-slate-500 py-2">No dead clicks yet</td></tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="grid gap-5 md:grid-cols-2">
            <div class="card-surface p-6">
              <div class="flex items-center justify-between flex-wrap gap-3 mb-3">
                <h2 class="text-xl font-semibold text-[#0f3f46] m-0">Hover intent targets</h2>
                <span class="badge-muted">Longer dwells</span>
              </div>
              <div class="overflow-x-auto">
                <table class="table-basic text-sm w-full">
                  <thead class="text-[#0f3f46]">
                    <tr><th>Target</th><th>Hovers</th><th>Avg dwell</th></tr>
                  </thead>
                  <tbody>
                    {% for row in hover_targets %}
                    <tr>
                      <td>{{ row.label|default:"(no label)" }}</td>
                      <td>{{ row.count }}</td>
                      <td>{{ row.avg_duration_label }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="3" class="text-slate-500 py-2">No hover intents yet</td></tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>

            <div class="card-surface p-6">
              <div class="flex items-center justify-between flex-wrap gap-3 mb-3">
                <h2 class="text-xl font-semibold text-[#0f3f46] m-0">Exit paths</h2>
                <span class="badge-muted">Where sessions end</span>
              </div>
              <div class="overflow-x-auto">
                <table class="table-basic text-sm w-full">
                  <thead class="text-[#0f3f46]">
                    <tr><th>Path</th><th>Exits</th><th>Sessions</th><th>Avg scroll</th></tr>
                  </thead>
                  <tbody>
                    {% for row in exit_by_path %}
                    <tr>
                      <td>{{ row.path }}</td>
                      <td>{{ row.count }}</td>
                      <td>{{ row.sessions }}</td>
                      <td>{{ row.avg_scroll_label }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="4" class="text-slate-500 py-2">No exits tracked yet</td></tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="card-surface p-6">
            <div class="flex items-center justify-between flex-wrap gap-3 mb-3">
              <h2 class="text-xl font-semibold text-[#0f3f46] m-0">Click path sequences</h2>
              <span class="badge-muted">Last interactions before exit</span>
            </div>
            <div class="overflow-x-auto">
              <table class="table-basic text-sm w-full">
                <thead class="text-[#0f3f46]">
                  <tr><th>Sequence</th><th>Occurrences</th><th>Sessions</th><th>Avg scroll</th></tr>
                </thead>
                <tbody>
                  {% for row in click_paths %}
                  <tr>
                    <td>{{ row.metadata__click_path }}</td>
                    <td>{{ row.count }}</td>
                    <td>{{ row.sessions }}</td>
                    <td>{{ row.avg_scroll_label }}</td>
                  </tr>
                  {% empty %}
                  <tr><td colspan="4" class="text-slate-500 py-2">No click paths recorded yet</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

          <div class="card-surface p-6">
            <div class="flex items-center justify-between flex-wrap gap-3 mb-3">
              <h2 class="text-xl font-semibold text-[#0f3f46] m-0">Top landing referrers</h2>
              <span class="badge-muted">By unique sessions</span>
            </div>
            <div class="overflow-x-auto">
              <table class="table-basic text-sm w-full">
                <thead class="text-[#0f3f46]">
                  <tr><th>Referrer</th><th>Sessions</th><th>Events</th></tr>
                </thead>
                <tbody>
                  {% for row in landing_referrers %}
                  <tr>
                    <td>{{ row.metadata__landing_referrer|default:"Direct / none" }}</td>
                    <td>{{ row.sessions }}</td>
                    <td>{{ row.events }}</td>
                  </tr>
                  {% empty %}
                  <tr><td colspan="3" class="text-slate-500 py-2">No referrers captured yet</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

            <div class="grid gap-4 md:grid-cols-2">
              <div class="card-surface p-5">
                <div class="text-sm text-slate-600">Auth successes</div>
                <div class="text-3xl font-semibold text-[#0f3f46]">{{ auth_successes }}</div>
                <div class="text-xs text-slate-500">Logins (all users)</div>
              </div>
              <div class="card-surface p-5">
                <div class="text-sm text-slate-600">Auth failures</div>
                <div class="text-3xl font-semibold text-[#0f3f46]">{{ auth_failures }}</div>
                <div class="text-xs text-slate-500">Failed login attempts</div>
              </div>
            </div>

          <div class="card-surface p-6">
            <div class="flex items-center justify-between flex-wrap gap-3 mb-3">
              <h2 class="text-xl font-semibold text-[#0f3f46] m-0">Top locations</h2>
              <span class="badge-muted">By event count</span>
            </div>
            <div class="overflow-x-auto">
              <table class="table-basic text-sm w-full">
                <thead class="text-[#0f3f46]">
                  <tr><th>Country</th><th>Region/State</th><th>City</th><th>Timezone</th><th>Events</th><th>Sessions</th></tr>
                </thead>
                <tbody>
                  {% for row in locations %}
                  <tr>
                    <td>{{ row.country_code|upper }}</td>
                    <td>{{ row.region }}</td>
                    <td>{{ row.city }}</td>
                    <td>{{ row.timezone }}</td>
                    <td>{{ row.count }}</td>
                    <td>{{ row.sessions }}</td>
                  </tr>
                  {% empty %}
                  <tr><td colspan="6" class="text-slate-500 py-2">No location data captured yet</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

          <div class="card-surface p-6">
            <div class="flex items-center justify-between flex-wrap gap-3 mb-3">
              <h2 class="text-xl font-semibold text-[#0f3f46] m-0">Recent failed logins</h2>
              <span class="badge-muted">Last 20</span>
            </div>
            <div class="overflow-x-auto">
              <table class="table-basic text-sm w-full">
                <thead class="text-[#0f3f46]">
                  <tr><th>When</th><th>Path</th><th>Region/City</th><th>Timezone</th><th>User agent</th><th>Referrer</th></tr>
                </thead>
                <tbody>
                  {% for row in recent_failures %}
                  <tr>
                    <td>{{ row.created|date:"Y-m-d H:i" }}</td>
                    <td>{{ row.path }}</td>
                    <td>{{ row.region }}{% if row.region and row.city %}, {% endif %}{{ row.city }}</td>
                    <td>{{ row.timezone }}</td>
                    <td>{{ row.user_agent|truncatechars:60 }}</td>
                    <td>{{ row.referrer|default:""|truncatechars:40 }}</td>
                  </tr>
                  {% empty %}
                  <tr><td colspan="6" class="text-slate-500 py-2">No failed logins yet</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

          <div class="card-surface p-6 flex items-center justify-between flex-wrap gap-3">
            <div>
              <h2 class="text-xl font-semibold text-[#0f3f46] m-0">Average scroll depth</h2>
              <p class="text-slate-600 text-sm m-0">Across scroll events</p>
            </div>
            <div class="text-3xl font-semibold text-[#0f3f46]">{{ avg_scroll|floatformat:0 }}%</div>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>
{% endblock %}

{% block before_footer %}
  <div aria-hidden="true" class="w-full bg-brand-deep h-16"></div>
{% endblock %}
